{"version":3,"file":"copyTextureToTexture.js","sourceRoot":"","sources":["../../../../dev/core/src/Misc/copyTextureToTexture.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ThinEngine } from \"core/Engines/thinEngine\";\r\nimport type { InternalTexture } from \"../Materials/Textures/internalTexture\";\r\nimport { EffectRenderer, EffectWrapper } from \"../Materials/effectRenderer\";\r\nimport type { IRenderTargetTexture, RenderTargetWrapper } from \"../Engines/renderTargetWrapper\";\r\nimport type { ThinTexture } from \"../Materials/Textures/thinTexture\";\r\nimport { Constants } from \"core/Engines/constants\";\r\n\r\nimport \"../Shaders/copyTextureToTexture.fragment\";\r\n\r\n/**\r\n * Conversion modes available when copying a texture into another one\r\n */\r\nexport enum ConversionMode {\r\n    None = 0,\r\n    ToLinearSpace = 1,\r\n    ToGammaSpace = 2,\r\n}\r\n\r\n/**\r\n * Class used for fast copy from one texture to another\r\n */\r\nexport class CopyTextureToTexture {\r\n    private _engine: ThinEngine;\r\n    private _isDepthTexture: boolean;\r\n    private _renderer: EffectRenderer;\r\n    private _effectWrapper: EffectWrapper;\r\n    private _source: InternalTexture | ThinTexture;\r\n    private _conversion: number;\r\n\r\n    private _textureIsInternal(texture: InternalTexture | ThinTexture): texture is InternalTexture {\r\n        return (texture as ThinTexture).getInternalTexture === undefined;\r\n    }\r\n\r\n    /**\r\n     * Constructs a new instance of the class\r\n     * @param engine The engine to use for the copy\r\n     * @param isDepthTexture True means that we should write (using gl_FragDepth) into the depth texture attached to the destination (default: false)\r\n     */\r\n    constructor(engine: ThinEngine, isDepthTexture = false) {\r\n        this._engine = engine;\r\n        this._isDepthTexture = isDepthTexture;\r\n\r\n        this._renderer = new EffectRenderer(engine);\r\n\r\n        this._effectWrapper = new EffectWrapper({\r\n            engine: engine,\r\n            name: \"CopyTextureToTexture\",\r\n            fragmentShader: \"copyTextureToTexture\",\r\n            useShaderStore: true,\r\n            uniformNames: [\"conversion\"],\r\n            samplerNames: [\"textureSampler\"],\r\n            defines: isDepthTexture ? [\"#define DEPTH_TEXTURE\"] : [],\r\n        });\r\n\r\n        this._effectWrapper.onApplyObservable.add(() => {\r\n            if (isDepthTexture) {\r\n                engine.setState(false);\r\n                engine.setDepthBuffer(true);\r\n                engine.depthCullingState.depthMask = true;\r\n                engine.depthCullingState.depthFunc = Constants.ALWAYS;\r\n            }\r\n\r\n            if (this._textureIsInternal(this._source)) {\r\n                this._effectWrapper.effect._bindTexture(\"textureSampler\", this._source);\r\n            } else {\r\n                this._effectWrapper.effect.setTexture(\"textureSampler\", this._source);\r\n            }\r\n            this._effectWrapper.effect.setFloat(\"conversion\", this._conversion);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Indicates if the effect is ready to be used for the copy\r\n     * @returns true if \"copy\" can be called without delay, else false\r\n     */\r\n    public isReady(): boolean {\r\n        return this._effectWrapper.effect.isReady();\r\n    }\r\n\r\n    /**\r\n     * Copy one texture into another\r\n     * @param source The source texture\r\n     * @param destination The destination texture\r\n     * @param conversion The conversion mode that should be applied when copying\r\n     * @returns\r\n     */\r\n    public copy(source: InternalTexture | ThinTexture, destination: RenderTargetWrapper | IRenderTargetTexture, conversion = ConversionMode.None): boolean {\r\n        if (!this.isReady()) {\r\n            return false;\r\n        }\r\n\r\n        this._source = source;\r\n        this._conversion = conversion;\r\n\r\n        const engineDepthFunc = this._engine.depthCullingState.depthFunc;\r\n\r\n        this._renderer.render(this._effectWrapper, destination);\r\n\r\n        if (this._isDepthTexture && engineDepthFunc) {\r\n            this._engine.depthCullingState.depthFunc = engineDepthFunc;\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Releases all the resources used by the class\r\n     */\r\n    public dispose(): void {\r\n        this._effectWrapper.dispose();\r\n        this._renderer.dispose();\r\n    }\r\n}\r\n"]}