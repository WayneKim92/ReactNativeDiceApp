{"version":3,"names":["defineAnimation","getReduceMotionForAnimation","isWeb","IS_WEB","withDecay","userConfig","callback","config","deceleration","velocityFactor","velocity","rubberBandFactor","Object","keys","forEach","key","VELOCITY_EPS","DERIVATIVE_EPS","SLOPE_FACTOR","decay","rubberBandEffect","animation","now","lastTimestamp","startTimestamp","current","deltaTime","Math","min","clampIndex","abs","clamp","derivative","v","exp","springActive","initialVelocity","validateConfig","Array","isArray","Error","length","onStart","value","reduceMotion","onFrame"],"sources":["decay.ts"],"sourcesContent":["import { defineAnimation, getReduceMotionForAnimation } from './util';\nimport type {\n  Animation,\n  AnimationCallback,\n  AnimationObject,\n  AnimatableValue,\n  Timestamp,\n  ReduceMotion,\n} from '../commonTypes';\nimport { isWeb } from '../PlatformChecker';\n\ninterface DecayConfig {\n  deceleration?: number;\n  velocityFactor?: number;\n  rubberBandEffect?: boolean;\n  clamp?: number[];\n  velocity?: number;\n  reduceMotion?: ReduceMotion;\n}\n\nexport type WithDecayConfig = DecayConfig;\n\ninterface DefaultDecayConfig {\n  deceleration: number;\n  velocityFactor: number;\n  clamp?: number[];\n  velocity: number;\n  reduceMotion?: ReduceMotion;\n  rubberBandEffect?: boolean;\n  rubberBandFactor: number;\n}\n\nexport interface DecayAnimation extends Animation<DecayAnimation> {\n  lastTimestamp: Timestamp;\n  startTimestamp: Timestamp;\n  initialVelocity: number;\n  velocity: number;\n  current: AnimatableValue;\n}\n\ninterface InnerDecayAnimation\n  extends Omit<DecayAnimation, 'current'>,\n    AnimationObject {\n  current: number;\n}\n\nconst IS_WEB = isWeb();\n\n// TODO TYPESCRIPT This is a temporary type to get rid of .d.ts file.\ntype withDecayType = (\n  userConfig: DecayConfig,\n  callback?: AnimationCallback\n) => number;\n\nexport const withDecay = function (\n  userConfig: DecayConfig,\n  callback?: AnimationCallback\n): Animation<DecayAnimation> {\n  'worklet';\n\n  return defineAnimation<DecayAnimation>(0, () => {\n    'worklet';\n    const config: DefaultDecayConfig = {\n      deceleration: 0.998,\n      velocityFactor: 1,\n      velocity: 0,\n      rubberBandFactor: 0.6,\n    };\n    if (userConfig) {\n      Object.keys(userConfig).forEach(\n        (key) =>\n          ((config as any)[key] = userConfig[key as keyof typeof userConfig])\n      );\n    }\n\n    const VELOCITY_EPS = IS_WEB ? 1 / 20 : 1;\n    const DERIVATIVE_EPS = 0.1;\n    const SLOPE_FACTOR = 0.1;\n\n    let decay: (animation: InnerDecayAnimation, now: number) => boolean;\n\n    if (config.rubberBandEffect) {\n      decay = (animation: InnerDecayAnimation, now: number): boolean => {\n        const { lastTimestamp, startTimestamp, current, velocity } = animation;\n\n        const deltaTime = Math.min(now - lastTimestamp, 64);\n        const clampIndex =\n          Math.abs(current - config.clamp![0]) <\n          Math.abs(current - config.clamp![1])\n            ? 0\n            : 1;\n\n        let derivative = 0;\n        if (current < config.clamp![0] || current > config.clamp![1]) {\n          derivative = current - config.clamp![clampIndex];\n        }\n\n        const v =\n          velocity *\n            Math.exp(\n              -(1 - config.deceleration) * (now - startTimestamp) * SLOPE_FACTOR\n            ) -\n          derivative * config.rubberBandFactor;\n\n        if (Math.abs(derivative) > DERIVATIVE_EPS) {\n          animation.springActive = true;\n        } else if (animation.springActive) {\n          animation.current = config.clamp![clampIndex];\n          return true;\n        } else if (Math.abs(v) < VELOCITY_EPS) {\n          return true;\n        }\n\n        animation.current =\n          current + (v * config.velocityFactor * deltaTime) / 1000;\n        animation.velocity = v;\n        animation.lastTimestamp = now;\n        return false;\n      };\n    } else {\n      decay = (animation: InnerDecayAnimation, now: number): boolean => {\n        const {\n          lastTimestamp,\n          startTimestamp,\n          initialVelocity,\n          current,\n          velocity,\n        } = animation;\n\n        const deltaTime = Math.min(now - lastTimestamp, 64);\n        const v =\n          velocity *\n          Math.exp(\n            -(1 - config.deceleration) * (now - startTimestamp) * SLOPE_FACTOR\n          );\n        animation.current =\n          current + (v * config.velocityFactor * deltaTime) / 1000;\n        animation.velocity = v;\n        animation.lastTimestamp = now;\n\n        if (config.clamp) {\n          if (initialVelocity < 0 && animation.current <= config.clamp[0]) {\n            animation.current = config.clamp[0];\n            return true;\n          } else if (\n            initialVelocity > 0 &&\n            animation.current >= config.clamp[1]\n          ) {\n            animation.current = config.clamp[1];\n            return true;\n          }\n        }\n\n        return Math.abs(v) < VELOCITY_EPS;\n      };\n    }\n\n    function validateConfig(): void {\n      if (config.clamp) {\n        if (!Array.isArray(config.clamp)) {\n          throw new Error(\n            `[Reanimated] \\`config.clamp\\` must be an array but is ${typeof config.clamp}.`\n          );\n        }\n        if (config.clamp.length !== 2) {\n          throw new Error(\n            `[Reanimated] \\`clamp array\\` must contain 2 items but is given ${config.clamp.length}.`\n          );\n        }\n      }\n      if (config.velocityFactor <= 0) {\n        throw new Error(\n          `[Reanimated] \\`config.velocityFactor\\` must be greather then 0 but is ${config.velocityFactor}.`\n        );\n      }\n      if (config.rubberBandEffect && !config.clamp) {\n        throw new Error(\n          '[Reanimated] You need to set `clamp` property when using `rubberBandEffect`.'\n        );\n      }\n    }\n\n    function onStart(\n      animation: DecayAnimation,\n      value: number,\n      now: Timestamp\n    ): void {\n      animation.current = value;\n      animation.lastTimestamp = now;\n      animation.startTimestamp = now;\n      animation.initialVelocity = config.velocity;\n      validateConfig();\n\n      if (animation.reduceMotion && config.clamp) {\n        if (value < config.clamp[0]) {\n          animation.current = config.clamp[0];\n        } else if (value > config.clamp[1]) {\n          animation.current = config.clamp[1];\n        }\n      }\n    }\n\n    return {\n      onFrame: decay,\n      onStart,\n      callback,\n      velocity: config.velocity ?? 0,\n      initialVelocity: 0,\n      current: 0,\n      lastTimestamp: 0,\n      startTimestamp: 0,\n      reduceMotion: getReduceMotionForAnimation(config.reduceMotion),\n    } as DecayAnimation;\n  });\n} as unknown as withDecayType;\n"],"mappings":"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"}