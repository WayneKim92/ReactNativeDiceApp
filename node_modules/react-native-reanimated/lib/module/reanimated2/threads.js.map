{"version":3,"names":["NativeReanimatedModule","isJest","shouldBeUseWeb","makeShareableCloneOnUIRecursive","makeShareableCloneRecursive","IS_JEST","IS_NATIVE","_runOnUIQueue","setupMicrotasks","microtasksQueue","isExecutingMicrotasksQueue","global","queueMicrotask","callback","push","__callMicrotasks","index","length","_maybeFlushUIUpdatesQueue","callMicrotasksOnUIThread","callMicrotasks","runOnUI","worklet","__DEV__","_WORKLET","Error","__workletHash","undefined","_len","arguments","args","Array","_key","scheduleOnUI","queue","forEach","_ref","runOnUIImmediately","_len2","_key2","f","runWorkletOnJS","_len3","_key3","runOnJS","fun","_len4","_key4","_len5","_key5","__remoteFunction","_len6","_key6","_scheduleOnJS"],"sources":["threads.ts"],"sourcesContent":["import NativeReanimatedModule from './NativeReanimated';\nimport { isJest, shouldBeUseWeb } from './PlatformChecker';\nimport type { WorkletFunction } from './commonTypes';\nimport {\n  makeShareableCloneOnUIRecursive,\n  makeShareableCloneRecursive,\n} from './shareables';\n\nconst IS_JEST = isJest();\nconst IS_NATIVE = !shouldBeUseWeb();\n\n/**\n * An array of [worklet, args] pairs.\n * */\nlet _runOnUIQueue: Array<[WorkletFunction<unknown[], unknown>, unknown[]]> = [];\n\nexport function setupMicrotasks() {\n  'worklet';\n\n  let microtasksQueue: Array<() => void> = [];\n  let isExecutingMicrotasksQueue = false;\n  global.queueMicrotask = (callback: () => void) => {\n    microtasksQueue.push(callback);\n  };\n\n  global.__callMicrotasks = () => {\n    if (isExecutingMicrotasksQueue) {\n      return;\n    }\n    try {\n      isExecutingMicrotasksQueue = true;\n      for (let index = 0; index < microtasksQueue.length; index += 1) {\n        // we use classic 'for' loop because the size of the currentTasks array may change while executing some of the callbacks due to queueMicrotask calls\n        microtasksQueue[index]();\n      }\n      microtasksQueue = [];\n      global._maybeFlushUIUpdatesQueue();\n    } finally {\n      isExecutingMicrotasksQueue = false;\n    }\n  };\n}\n\nfunction callMicrotasksOnUIThread() {\n  'worklet';\n  global.__callMicrotasks();\n}\n\nexport const callMicrotasks = IS_NATIVE\n  ? callMicrotasksOnUIThread\n  : () => {\n      // on web flushing is a noop as immediates are handled by the browser\n    };\n\n// @ts-expect-error This overload is correct since it's what user sees in his code\n// before it's transformed by Reanimated Babel plugin.\nexport function runOnUI<Args extends unknown[], ReturnValue>(\n  worklet: (...args: Args) => ReturnValue\n): (...args: Args) => void;\n/**\n * Schedule a worklet to execute on the UI runtime. This method does not schedule the work immediately but instead\n * waits for other worklets to be scheduled within the same JS loop. It uses queueMicrotask to schedule all the worklets\n * at once making sure they will run within the same frame boundaries on the UI thread.\n */\nexport function runOnUI<Args extends unknown[], ReturnValue>(\n  worklet: WorkletFunction<Args, ReturnValue>\n): (...args: Args) => void {\n  'worklet';\n  if (__DEV__ && IS_NATIVE && _WORKLET) {\n    throw new Error(\n      '[Reanimated] `runOnUI` cannot be called on the UI runtime. Please call the function synchronously or use `queueMicrotask` or `requestAnimationFrame` instead.'\n    );\n  }\n  if (__DEV__ && IS_NATIVE && worklet.__workletHash === undefined) {\n    throw new Error('[Reanimated] `runOnUI` can only be used on worklets.');\n  }\n  return (...args) => {\n    if (IS_JEST) {\n      // Mocking time in Jest is tricky as both requestAnimationFrame and queueMicrotask\n      // callbacks run on the same queue and can be interleaved. There is no way\n      // to flush particular queue in Jest and the only control over mocked timers\n      // is by using jest.advanceTimersByTime() method which advances all types\n      // of timers including immediate and animation callbacks. Ideally we'd like\n      // to have some way here to schedule work along with React updates, but\n      // that's not possible, and hence in Jest environment instead of using scheduling\n      // mechanism we just schedule the work ommiting the queue. This is ok for the\n      // uses that we currently have but may not be ok for future tests that we write.\n      NativeReanimatedModule.scheduleOnUI(\n        makeShareableCloneRecursive(() => {\n          'worklet';\n          worklet(...args);\n        })\n      );\n      return;\n    }\n    if (__DEV__) {\n      // in DEV mode we call shareable conversion here because in case the object\n      // can't be converted, we will get a meaningful stack-trace as opposed to the\n      // situation when conversion is only done via microtask queue. This does not\n      // make the app particularily less efficient as converted objects are cached\n      // and for a given worklet the conversion only happens once.\n      makeShareableCloneRecursive(worklet);\n      makeShareableCloneRecursive(args);\n    }\n    //\n    _runOnUIQueue.push([worklet as WorkletFunction<unknown[], unknown>, args]);\n    if (_runOnUIQueue.length === 1) {\n      queueMicrotask(() => {\n        const queue = _runOnUIQueue;\n        _runOnUIQueue = [];\n        NativeReanimatedModule.scheduleOnUI(\n          makeShareableCloneRecursive(() => {\n            'worklet';\n            queue.forEach(([worklet, args]) => {\n              worklet(...args);\n            });\n            callMicrotasks();\n          })\n        );\n      });\n    }\n  };\n}\n\n// @ts-expect-error Check `runOnUI` overload above.\nexport function runOnUIImmediately<Args extends unknown[], ReturnValue>(\n  worklet: (...args: Args) => ReturnValue\n): WorkletFunction<Args, ReturnValue>;\n/**\n * Schedule a worklet to execute on the UI runtime skipping batching mechanism.\n */\nexport function runOnUIImmediately<Args extends unknown[], ReturnValue>(\n  worklet: WorkletFunction<Args, ReturnValue>\n): (...args: Args) => void {\n  'worklet';\n  if (__DEV__ && IS_NATIVE && _WORKLET) {\n    throw new Error(\n      '[Reanimated] `runOnUIImmediately` cannot be called on the UI runtime. Please call the function synchronously or use `queueMicrotask` or `requestAnimationFrame` instead.'\n    );\n  }\n  if (__DEV__ && IS_NATIVE && worklet.__workletHash === undefined) {\n    throw new Error(\n      '[Reanimated] `runOnUIImmediately` can only be used on worklets.'\n    );\n  }\n  return (...args) => {\n    NativeReanimatedModule.scheduleOnUI(\n      makeShareableCloneRecursive(() => {\n        'worklet';\n        worklet(...args);\n      })\n    );\n  };\n}\n\nif (__DEV__ && IS_NATIVE) {\n  const f = (() => {\n    'worklet';\n  }) as WorkletFunction<[], void>;\n  if (f.__workletHash === undefined) {\n    throw new Error(\n      `[Reanimated] Failed to create a worklet. See \\`https://docs.swmansion.com/react-native-reanimated/docs/guides/troubleshooting#failed-to-create-a-worklet\\` for more details.`\n    );\n  }\n}\n\ntype ReleaseRemoteFunction<Args extends unknown[], ReturnValue> = {\n  (...args: Args): ReturnValue;\n};\n\ntype DevRemoteFunction<Args extends unknown[], ReturnValue> = {\n  __remoteFunction: (...args: Args) => ReturnValue;\n};\n\ntype RemoteFunction<Args extends unknown[], ReturnValue> =\n  | ReleaseRemoteFunction<Args, ReturnValue>\n  | DevRemoteFunction<Args, ReturnValue>;\n\nfunction runWorkletOnJS<Args extends unknown[], ReturnValue>(\n  worklet: WorkletFunction<Args, ReturnValue>,\n  ...args: Args\n): void {\n  // remote function that calls a worklet synchronously on the JS runtime\n  worklet(...args);\n}\n\n/**\n * Returns a function that can be called to be executed asynchronously on both\n * UI and JS threads.\n */\nexport function runOnJS<Args extends unknown[], ReturnValue>(\n  fun:\n    | ((...args: Args) => ReturnValue)\n    | RemoteFunction<Args, ReturnValue>\n    | WorkletFunction<Args, ReturnValue>\n): (...args: Args) => void {\n  'worklet';\n  type FunWorklet = Extract<typeof fun, WorkletFunction<Args, ReturnValue>>;\n  type FunDevRemote = Extract<typeof fun, DevRemoteFunction<Args, ReturnValue>>;\n  if (!IS_NATIVE || !_WORKLET) {\n    // if we are already on the JS thread, we just schedule the worklet on the JS queue\n    return (...args) =>\n      queueMicrotask(\n        args.length\n          ? () => (fun as (...args: Args) => ReturnValue)(...args)\n          : (fun as () => ReturnValue)\n      );\n  }\n  if ((fun as FunWorklet).__workletHash) {\n    // If `fun` is a worklet, we schedule a call of a remote function `runWorkletOnJS`\n    // and pass the worklet as a first argument followed by original arguments.\n\n    return (...args) =>\n      runOnJS(runWorkletOnJS<Args, ReturnValue>)(\n        fun as WorkletFunction<Args, ReturnValue>,\n        ...args\n      );\n  }\n  if ((fun as FunDevRemote).__remoteFunction) {\n    // In development mode the function provided as `fun` throws an error message\n    // such that when someone accidentally calls it directly on the UI runtime, they\n    // see that they should use `runOnJS` instead. To facilitate that we put the\n    // reference to the original remote function in the `__functionInDEV` property.\n    fun = (fun as FunDevRemote).__remoteFunction;\n  }\n  return (...args) => {\n    _scheduleOnJS(\n      fun as\n        | ((...args: Args) => ReturnValue)\n        | WorkletFunction<Args, ReturnValue>,\n      args.length > 0\n        ? // TODO TYPESCRIPT this cast is terrible but will be fixed\n          (makeShareableCloneOnUIRecursive(args) as unknown as unknown[])\n        : undefined\n    );\n  };\n}\n"],"mappings":"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"}